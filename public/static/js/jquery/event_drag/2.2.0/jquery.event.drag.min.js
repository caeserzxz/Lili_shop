define(function(n){var t=n("$");(function(n){var u,f;n.fn.drag=function(t,i,r){var u=typeof t=="string"?t:"",f=n.isFunction(t)?t:n.isFunction(i)?i:null;return u.indexOf("drag")!==0&&(u="drag"+u),r=(t==f?i:r)||{},f?this.bind(u,r,f):this.trigger(u)};var i=n.event,r=i.special,t=r.drag={defaults:{which:1,distance:0,not:":input",handle:null,relative:!1,drop:!0,click:!1},datakey:"dragdata",noBubble:!0,add:function(i){var r=n.data(this,t.datakey),u=i.data||{};r.related+=1;n.each(t.defaults,function(n){u[n]!==undefined&&(r[n]=u[n])})},remove:function(){n.data(this,t.datakey).related-=1},setup:function(){if(!n.data(this,t.datakey)){var r=n.extend({related:0},t.defaults);n.data(this,t.datakey,r);i.add(this,"touchstart mousedown",t.init,r);this.attachEvent&&this.attachEvent("ondragstart",t.dontstart)}},teardown:function(){var r=n.data(this,t.datakey)||{};r.related||(n.removeData(this,t.datakey),i.remove(this,"touchstart mousedown",t.init),t.textselect(!0),this.detachEvent&&this.detachEvent("ondragstart",t.dontstart))},init:function(u){if(!t.touched){var f=u.data,e;if(u.which==0||!(f.which>0)||u.which==f.which)return n(u.target).is(f.not)?void 0:f.handle&&!n(u.target).closest(f.handle,u.currentTarget).length?void 0:(t.touched=u.type=="touchstart"?this:null,f.propagates=1,f.mousedown=this,f.interactions=[t.interaction(this,f)],f.target=u.target,f.pageX=u.pageX,f.pageY=u.pageY,f.dragging=null,e=t.hijack(u,"draginit",f),!f.propagates)?void 0:(e=t.flatten(e),e&&e.length&&(f.interactions=[],n.each(e,function(){f.interactions.push(t.interaction(this,f))})),f.propagates=f.interactions.length,f.drop!==!1&&r.drop&&r.drop.handler(u,f),t.textselect(!1),t.touched?i.add(t.touched,"touchmove touchend",t.handler,f):i.add(document,"mousemove mouseup",t.handler,f),!t.touched||f.live?!1:void 0)}},interaction:function(i,r){var u=n(i)[r.relative?"position":"offset"]()||{top:0,left:0};return{drag:i,callback:new t.callback,droppable:[],offset:u}},handler:function(u){var f=u.data;switch(u.type){case!f.dragging&&"touchmove":u.preventDefault();case!f.dragging&&"mousemove":if(Math.pow(u.pageX-f.pageX,2)+Math.pow(u.pageY-f.pageY,2)<Math.pow(f.distance,2))break;u.target=f.target;t.hijack(u,"dragstart",f);f.propagates&&(f.dragging=!0);case"touchmove":u.preventDefault();case"mousemove":if(f.dragging){if(t.hijack(u,"drag",f),f.propagates){f.drop!==!1&&r.drop&&r.drop.handler(u,f);break}u.type="mouseup"}case"touchend":case"mouseup":default:t.touched?i.remove(t.touched,"touchmove touchend",t.handler):i.remove(document,"mousemove mouseup",t.handler);f.dragging&&(f.drop!==!1&&r.drop&&r.drop.handler(u,f),t.hijack(u,"dragend",f));t.textselect(!0);f.click===!1&&f.dragging&&n.data(f.mousedown,"suppress.click",(new Date).getTime()+5);f.dragging=t.touched=!1}},hijack:function(r,u,f,e,o){if(f){var v={event:r.originalEvent,type:r.type},l=u.indexOf("drop")?"drag":"drop",h,a=e||0,s,c,y=isNaN(e)?f.interactions.length:e;r.type=u;r.originalEvent=null;f.results=[];do if(s=f.interactions[a]){if(u!=="dragend"&&s.cancelled)continue;c=t.properties(r,f,s);s.results=[];n(o||s[l]||f.droppable).each(function(e,o){return c.target=o,r.isPropagationStopped=function(){return!1},h=o?i.dispatch.call(o,r,c):null,h===!1?(l=="drag"&&(s.cancelled=!0,f.propagates-=1),u=="drop"&&(s[l][e]=null)):u=="dropinit"&&s.droppable.push(t.element(h)||o),u=="dragstart"&&(s.proxy=n(t.element(h)||s.drag)[0]),s.results.push(h),delete r.result,u!=="dropinit"?h:void 0});f.results[a]=t.flatten(s.results);u=="dropinit"&&(s.droppable=t.flatten(s.droppable));u!="dragstart"||s.cancelled||c.update()}while(++a<y);return r.type=v.type,r.originalEvent=v.event,t.flatten(f.results)}},properties:function(n,i,r){var u=r.callback;return u.drag=r.drag,u.proxy=r.proxy||r.drag,u.startX=i.pageX,u.startY=i.pageY,u.deltaX=n.pageX-i.pageX,u.deltaY=n.pageY-i.pageY,u.originalX=r.offset.left,u.originalY=r.offset.top,u.offsetX=u.originalX+u.deltaX,u.offsetY=u.originalY+u.deltaY,u.drop=t.flatten((r.drop||[]).slice()),u.available=t.flatten((r.droppable||[]).slice()),u},element:function(n){if(n&&(n.jquery||n.nodeType==1))return n},flatten:function(i){return n.map(i,function(i){return i&&i.jquery?n.makeArray(i):i&&i.length?t.flatten(i):i})},textselect:function(i){n(document)[i?"unbind":"bind"]("selectstart",t.dontstart).css("MozUserSelect",i?"":"none");document.unselectable=i?"off":"on"},dontstart:function(){return!1},callback:function(){}};t.callback.prototype={update:function(){r.drop&&this.available.length&&n.each(this.available,function(n){r.drop.locate(this,n)})}};u=i.dispatch;i.dispatch=function(t){if(n.data(this,"suppress."+t.type)-(new Date).getTime()>0){n.removeData(this,"suppress."+t.type);return}return u.apply(this,arguments)};f=i.fixHooks.touchstart=i.fixHooks.touchmove=i.fixHooks.touchend=i.fixHooks.touchcancel={props:"clientX clientY pageX pageY screenX screenY".split(" "),filter:function(t,i){if(i){var r=i.touches&&i.touches[0]||i.changedTouches&&i.changedTouches[0]||null;r&&n.each(f.props,function(n,i){t[i]=r[i]})}return t}};r.draginit=r.dragstart=r.dragend=t})(t)});