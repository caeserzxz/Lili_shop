define(function(n){var t=n("$");(function(n,t,i,r){function c(i,r){this.w=n(t);this.el=n(i);this.options=n.extend({},h,r);this.init()}var u="ontouchstart"in t,f=function(){var n=i.createElement("div"),r=i.documentElement,u;return("pointerEvents"in n.style)?(n.style.pointerEvents="auto",n.style.pointerEvents="x",r.appendChild(n),u=t.getComputedStyle&&t.getComputedStyle(n,"").pointerEvents==="auto",r.removeChild(n),!!u):!1}(),e=u?"touchstart":"mousedown",o=u?"touchmove":"mousemove",s=u?"touchend":"mouseup",h;eCancel=u?"touchcancel":"mouseup";h={listNodeName:"ol",itemNodeName:"li",rootClass:"dd",listClass:"dd-list",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",collapsedClass:"dd-collapsed",placeClass:"dd-placeholder",noDragClass:"dd-nodrag",emptyClass:"dd-empty",expandBtnHTML:'<button data-action="expand" type="button">Expand<\/button>',collapseBtnHTML:'<button data-action="collapse" type="button">Collapse<\/button>',group:0,maxDepth:5,threshold:20};c.prototype={init:function(){var i=this;i.reset();i.el.data("nestable-group",this.options.group);i.placeEl=n('<div class="'+i.options.placeClass+'"/>');n.each(this.el.find(i.options.itemNodeName),function(t,r){i.setParent(n(r))});i.el.on("click","button",function(t){if(!i.dragEl&&(u||t.button===0)){var r=n(t.currentTarget),f=r.data("action"),e=r.parent(i.options.itemNodeName);f==="collapse"&&i.collapseItem(e);f==="expand"&&i.expandItem(e)}});var f=function(t){var r=n(t.target);if(!r.hasClass(i.options.handleClass)){if(r.closest("."+i.options.noDragClass).length)return;r=r.closest("."+i.options.handleClass)}r.length&&!i.dragEl&&(u||t.button===0)&&(!u||t.touches.length===1)&&(t.preventDefault(),i.dragStart(u?t.touches[0]:t))},h=function(n){i.dragEl&&(n.preventDefault(),i.dragMove(u?n.touches[0]:n))},r=function(n){i.dragEl&&(n.preventDefault(),i.dragStop(u?n.touches[0]:n))};if(u)i.el[0].addEventListener(e,f,!1),t.addEventListener(o,h,!1),t.addEventListener(s,r,!1),t.addEventListener(eCancel,r,!1);else{i.el.on(e,f);i.w.on(o,h);i.w.on(s,r)}},serialize:function(){var t=this;return step=function(i,r){var u=[],f=i.children(t.options.itemNodeName);return f.each(function(){var i=n(this),f=n.extend({},i.data()),e=i.children(t.options.listNodeName);e.length&&(f.children=step(e,r+1));u.push(f)}),u},step(t.el.find(t.options.listNodeName).first(),0)},serialise:function(){return this.serialize()},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0};this.moving=!1;this.dragEl=null;this.dragRootEl=null;this.dragDepth=0;this.hasNewRoot=!1;this.pointEl=null},expandItem:function(n){n.removeClass(this.options.collapsedClass);n.children('[data-action="expand"]').hide();n.children('[data-action="collapse"]').show();n.children(this.options.listNodeName).show()},collapseItem:function(n){var t=n.children(this.options.listNodeName);t.length&&(n.addClass(this.options.collapsedClass),n.children('[data-action="collapse"]').hide(),n.children('[data-action="expand"]').show(),n.children(this.options.listNodeName).hide())},expandAll:function(){var t=this;t.el.find(t.options.itemNodeName).each(function(){t.expandItem(n(this))})},collapseAll:function(){var t=this;t.el.find(t.options.itemNodeName).each(function(){t.collapseItem(n(this))})},setParent:function(t){t.children(this.options.listNodeName).length&&(t.prepend(n(this.options.expandBtnHTML)),t.prepend(n(this.options.collapseBtnHTML)));t.children('[data-action="expand"]').hide()},unsetParent:function(n){n.removeClass(this.options.collapsedClass);n.children("[data-action]").remove();n.children(this.options.listNodeName).remove()},dragStart:function(t){var u=this.mouse,o=n(t.target),f=o.closest(this.options.itemNodeName),e,s,h;for(this.placeEl.css("height",f.height()),u.offsetX=t.offsetX!==r?t.offsetX:t.pageX-o.offset().left,u.offsetY=t.offsetY!==r?t.offsetY:t.pageY-o.offset().top,u.startX=u.lastX=t.pageX,u.startY=u.lastY=t.pageY,this.dragRootEl=this.el,this.dragEl=n(i.createElement(this.options.listNodeName)).addClass(this.options.listClass+" "+this.options.dragClass),this.dragEl.css("width",f.width()),f.after(this.placeEl),f[0].parentNode.removeChild(f[0]),f.appendTo(this.dragEl),n(i.body).append(this.dragEl),this.dragEl.css({left:t.pageX-u.offsetX,top:t.pageY-u.offsetY}),h=this.dragEl.find(this.options.itemNodeName),e=0;e<h.length;e++)s=n(h[e]).parents(this.options.listNodeName).length,s>this.dragDepth&&(this.dragDepth=s)},dragStop:function(){var n=this.dragEl.children(this.options.itemNodeName).first();n[0].parentNode.removeChild(n[0]);this.placeEl.replaceWith(n);this.dragEl.remove();this.el.trigger("change");this.hasNewRoot&&this.dragRootEl.trigger("change");this.reset()},dragMove:function(r){var o,h,s,p,c,e=this.options,u=this.mouse,l,a,v,y,w;if(this.dragEl.css({left:r.pageX-u.offsetX,top:r.pageY-u.offsetY}),u.lastX=u.nowX,u.lastY=u.nowY,u.nowX=r.pageX,u.nowY=r.pageY,u.distX=u.nowX-u.lastX,u.distY=u.nowY-u.lastY,u.lastDirX=u.dirX,u.lastDirY=u.dirY,u.dirX=u.distX===0?0:u.distX>0?1:-1,u.dirY=u.distY===0?0:u.distY>0?1:-1,l=Math.abs(u.distX)>Math.abs(u.distY)?1:0,!u.moving){u.dirAx=l;u.moving=!0;return}if(u.dirAx!==l?(u.distAxX=0,u.distAxY=0):(u.distAxX+=Math.abs(u.distX),u.dirX!==0&&u.dirX!==u.lastDirX&&(u.distAxX=0),u.distAxY+=Math.abs(u.distY),u.dirY!==0&&u.dirY!==u.lastDirY&&(u.distAxY=0)),u.dirAx=l,u.dirAx&&u.distAxX>=e.threshold&&(u.distAxX=0,s=this.placeEl.prev(e.itemNodeName),u.distX>0&&s.length&&!s.hasClass(e.collapsedClass)&&(o=s.find(e.listNodeName).last(),c=this.placeEl.parents(e.listNodeName).length,c+this.dragDepth<=e.maxDepth&&(o.length?(o=s.children(e.listNodeName).last(),o.append(this.placeEl)):(o=n("<"+e.listNodeName+"/>").addClass(e.listClass),o.append(this.placeEl),s.append(o),this.setParent(s)))),u.distX<0&&(p=this.placeEl.next(e.itemNodeName),p.length||(h=this.placeEl.parent(),this.placeEl.closest(e.itemNodeName).after(this.placeEl),h.children().length||this.unsetParent(h.parent())))),a=!1,f||(this.dragEl[0].style.visibility="hidden"),this.pointEl=n(i.elementFromPoint(r.pageX-i.body.scrollLeft,r.pageY-(t.pageYOffset||i.documentElement.scrollTop))),f||(this.dragEl[0].style.visibility="visible"),this.pointEl.hasClass(e.handleClass)&&(this.pointEl=this.pointEl.parent(e.itemNodeName)),this.pointEl.hasClass(e.emptyClass))a=!0;else if(!this.pointEl.length||!this.pointEl.hasClass(e.itemClass))return;if(v=this.pointEl.closest("."+e.rootClass),y=this.dragRootEl.data("nestable-id")!==v.data("nestable-id"),!u.dirAx||y||a){if(y&&e.group!==v.data("nestable-group"))return;if(c=this.dragDepth-1+this.pointEl.parents(e.listNodeName).length,c>e.maxDepth)return;w=r.pageY<this.pointEl.offset().top+this.pointEl.height()/2;h=this.placeEl.parent();a?(o=n(i.createElement(e.listNodeName)).addClass(e.listClass),o.append(this.placeEl),this.pointEl.replaceWith(o)):w?this.pointEl.before(this.placeEl):this.pointEl.after(this.placeEl);h.children().length||this.unsetParent(h.parent());this.dragRootEl.find(e.itemNodeName).length||this.dragRootEl.append('<div class="'+e.emptyClass+'"/>');y&&(this.dragRootEl=v,this.hasNewRoot=this.el[0]!==this.dragRootEl[0])}}};n.fn.nestable=function(t){var i=this,r=this;return i.each(function(){var i=n(this).data("nestable");i?typeof t=="string"&&typeof i[t]=="function"&&(r=i[t]()):(n(this).data("nestable",new c(this,t)),n(this).data("nestable-id",(new Date).getTime()))}),r||i}})(window.jQuery||window.Zepto,window,document)});