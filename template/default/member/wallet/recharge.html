{extend name="layouts@base" /}
{block name="head"}
<link rel="stylesheet" href="__STATIC__/mobile/default/css/wallet.css" />
{/block}
{block name="pageType"}chongzhi{/block}
{block name="main" }
<div class="page-bd">
        <!-- 页面内容-->  
          <div class="inputBlock">
            <div class="tips fs60 fw_b color_9">充值金额(元)</div>
            <input type="text" class="fs60 num textBox" id="amount"> 
          </div>
          <div class="paytype">
              <div class="title fs34 color_3 fw_b">请选择支付方式</div>
              <div class="cells">
                <div class="cell">
                    <div class="cell_hd"><img src="__STATIC__/mobile/default/images/weixinPay.png" alt=""></div>
                    <div class="cell_bd"><span class="fs30 color_3">微信支付</span></div>
                    <div class="cell_ft">
                    <label for="s11">
                        <div class="iconBox">
                          <input type="radio" class="check" value="wxpay" name="pay_type" id="s11" checked>
                          <i class="icon_checked"></i>
                        </div>
                    </label>
                  </div>
                </div>
                <div class="cell">
                    <div class="cell_hd"><img src="__STATIC__/mobile/default/images/AliPay.png" alt=""></div>
                    <div class="cell_bd"><span class="fs30 color_3">支付宝</span></div>
                    <div class="cell_ft">
                      <label for="s12">
                          <div class="iconBox">
                            <input type="radio" class="check" value="alipay" name="pay_type" id="s12">
                            <i class="icon_checked"></i>
                          </div>
                      </label>
                    </div>
                </div>
                <div class="cell">
                    <div class="cell_hd"><img src="__STATIC__/mobile/default/images/offlinePay.png" alt=""></div>
                    <div class="cell_bd"><span class="fs30 color_3">线下打款</span></div>
                    <div class="cell_ft">
                    <label for="s13">
                        <div class="iconBox">
                          <input type="radio" class="check" value="offline" name="pay_type" id="s13" >
                          <i class="icon_checked"></i>
                        </div>
                    </label>
                    </div>
                </div>
              </div>
              <div class="uploading">
                  <div class="title fs28 fw_b color_3">上传凭证</div>
                  <div class="uploadBox">
                     
                     <div class="Box">
                        <img src="__STATIC__/mobile/default/images/addImg.png" alt="" class="imgBox">
                        <input type="file" class="uploadInput" onchange="uploadFile(this,event)">    
                        
                      </div>
                  </div>
                </div>
            </div>

          <div class="button fs32 fw_b color_w BGcolor_r postBtn">确认充值</div>

    </div>
    </div>

{/block}

{block name="footer"}
<script type="text/javascript">
 
$(function(){
	$('.textBox').on('click',function(){
	  $(this).siblings().animate({'fontSize':'0.173333rem','top':'0.2666666rem'})
	})
	$('.inputBlock input').blur(function(){
	  if($(this).val()==''){
		$(this).siblings().animate({'fontSize':'0.4rem','top':'0.386667rem'})
	  }
	})
	$(".check").on('click',function(){
	  if ($('#s13').is(":checked")) {
		  $('.uploading').show()
	  }else{
		$('.uploading').hide()
	  }
	}) 
})
	  
var isPost = false
var fd = new FormData();
var imgNum = 0;
$('.postBtn').click(function(){
	var amount = $('#amount').val();
	if (amount < 1){
		_alert('充值金额不能少于1.');
		return false;
	}
	fd.append("pay_type", $('input:radio[name="pay_type"]:checked').val());	
	fd.append("amount", amount);	
	$.ajax({
		  url: '{:url("member/api.Wallet/recharge")}',
		  type: 'post',
		  processData: false,
		  contentType: false,
		  data: fd,
		  success: function (res) {
			 if (res.code == 0){
				  _alert(res.msg);
				  return false;	
			  }
			  _alert(res.msg,'{:url("member/wallet/index")}');			  
		  }
	})


})
//删除上传图片
$('.uploadBox').on('click','.closeImg',function(){
	$(this).parent().remove();
	fd.delete("imgfile["+$(this).data('imgnum')+"]");
})
//选择上传图片
function uploadFile(_this,e){	
	compress(e, function(base64Img){
		if (imgNum > 6){
			_alert('最多允许上传6张图片.');
			return false;	
		}
		imgNum++;
		fd.append("imgfile["+imgNum+"]", base64Img);
		$(_this).parent().before('<div class="Box"><img src="'+base64Img+'" alt="" class="imgBox"><img src="__STATIC__/mobile/default/images/closeImg.png" alt="" data-imgnum="'+imgNum+'" class="closeImg"></div>');
	})

}
//判断是否存在画布
function isCanvasSupported() {
	var elem = document.createElement('canvas');
	return !!(elem.getContext && elem.getContext('2d'));
}
 
//压缩方法
function compress(event, callback) {
	if ( typeof (FileReader) === 'undefined') {
		console.log("当前浏览器内核不支持base64图标压缩");
		//调用上传方式  不压缩
	} else {
		try {
			var file = event.currentTarget.files[0];
			 if(!/image\/\w+/.test(file.type)){   
        			alert("请确保文件为图像类型");  
        			return false;  
     		 } 
			var reader = new FileReader();
			reader.onload = function (e) {
			var image = $('<img/>');
			image.load(function () {
			console.log("开始压缩");
			var square = 700;
			var canvas = document.createElement('canvas');
			canvas.width = square;
			canvas.height = square;
			var context = canvas.getContext('2d');
		    context.clearRect(0, 0, square, square);
			var imageWidth;
			var imageHeight;
			var offsetX = 0;
			var offsetY = 0;
			if (this.width > this.height) {
		      imageWidth = Math.round(square * this.width / this.height);
		      imageHeight = square;
		      offsetX = - Math.round((imageWidth - square) / 2);
			} else {
		      imageHeight = Math.round(square * this.height / this.width);
		      imageWidth = square;
		      offsetY = - Math.round((imageHeight - square) / 2);
			}
			context.drawImage(this, offsetX, offsetY, imageWidth, imageHeight);
			var data = canvas.toDataURL('image/jpeg');
			 	//压缩完成执行回调
		     	callback(data);
			});
			image.attr('src', e.target.result);
			};
			reader.readAsDataURL(file);
		} catch(e) {
			console.log("压缩失败!");
			//调用上传方式  不压缩
		}
	}
}
</script>

{/block}